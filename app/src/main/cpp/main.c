#include <jni.h>
#include "sqlite3.h"
#include "utils.h"
#include "mongoose.h"
#include <net/if.h>
#include <android/asset_manager.h>
#include <android/asset_manager_jni.h>


static struct mg_serve_http_opts s_http_server_opts;

sqlite3 *CreateDatabase(const char *fileName) {

    sqlite3 *db;
    int rc = sqlite3_open(fileName, &db);
    if (rc) {
        LOGE("Can't open database: %s\n", sqlite3_errmsg(db));
        return NULL;
    }
    const char *sql = "CREATE TABLE IF NOT EXISTS note (\n" \
                      "    _id INTEGER PRIMARY KEY AUTOINCREMENT,\n" \
                      "    title VARCHAR(50) NOT NULL,\n" \
                      "    content TEXT NOT NULL,\n" \
                      "    created_at BIGINT NOT NULL,\n" \
                      "    updated_at BIGINT NOT NULL,\n" \
                      "    UNIQUE (created_at)\n" \
                      ");";
    char *errMsg;
    rc = sqlite3_exec(db, sql, NULL, 0, &errMsg);
    if (rc != SQLITE_OK) {
        LOGE("SQL error:%s\n", errMsg);
        sqlite3_free(errMsg);
    }

    return db;


}


void GetAssetFile(JNIEnv *ev, jobject assetManager) {
    AAssetManager *manager = AAssetManager_fromJava(ev, assetManager);
    if (manager == NULL) {
        return;
    }


}

void GetPath(JNIEnv *env, char *buf) {
    jclass envcls = (*env)->FindClass(env, "android/os/Environment"); //获得类引用
    if (envcls == NULL) return;

    //找到对应的类，该类是静态的返回值是File
    jmethodID id = (*env)->GetStaticMethodID(env, envcls, "getExternalStorageDirectory",
                                             "()Ljava/io/File;");

    //调用上述id获得的方法，返回对象即File file=Enviroment.getExternalStorageDirectory()
    //其实就是通过Enviroment调用 getExternalStorageDirectory()
    jobject fileObj = (*env)->CallStaticObjectMethod(env, envcls, id, "");

    //通过上述方法返回的对象创建一个引用即File对象
    jclass flieClass = (*env)->GetObjectClass(env, fileObj); //或得类引用
    //在调用File对象的getPath()方法获取该方法的ID，返回值为String 参数为空
    jmethodID getpathId = (*env)->GetMethodID(env, flieClass, "getPath", "()Ljava/lang/String;");
    //调用该方法及最终获得存储卡的根目录
    jstring pathStr = (jstring) (*env)->CallObjectMethod(env, fileObj, getpathId, "");

    char *path = (*env)->GetStringUTFChars(env, pathStr, NULL);

    //CreateDatabase(fileName);
    strcpy(buf, path);
    (*env)->ReleaseStringUTFChars(env, pathStr, path);
}

void GetIP(char *device) {
    int i = 0;
    int sockfd;
    struct ifconf ifconf;
    unsigned char buf[512];
    struct ifreq *ifreq;
    //初始化ifconf
    ifconf.ifc_len = 512;
    ifconf.ifc_buf = (char *) buf;
    if ((sockfd = socket(AF_INET, SOCK_DGRAM, 0)) < 0) {
        return;
    }
    ioctl(sockfd, SIOCGIFCONF, &ifconf); //获取所有接口信息
    //接下来一个一个的获取IP地址
    ifreq = (struct ifreq *) buf;

    for (i = (ifconf.ifc_len / sizeof(struct ifreq)); i > 0; i--) {
        // if(ifreq->ifr_flags == AF_INET){ //for ipv4
        char *ip = inet_ntoa(((struct sockaddr_in *) &(ifreq->ifr_addr))->sin_addr);
        LOGE("ip: %s\n", ip);
        if (strncmp(ip, "192.168", 7) == 0)
            strcpy(device, ip);
        // __android_log_print(ANDROID_LOG_INFO, "test", "%s", ip);
        ifreq++;
        // }
    }
}

static int is_equal(const struct mg_str *s1, const struct mg_str *s2) {
    return s1->len == s2->len && memcmp(s1->p, s2->p, s2->len) == 0;
}

static void ev_handler(struct mg_connection *nc, int ev, void *ev_data) {
    static const struct mg_str api_index = MG_MK_STR("/");

    static char t1[] = /* 0 1050 links */{60, 33, 68, 79, 67, 84, 89, 80, 69, 32, 104, 116, 109,
                                          108, 62, 60, 104, 116, 109, 108, 32, 108, 97, 110, 103,
                                          61, 34, 101, 110, 34, 62, 60, 104, 101, 97, 100, 62, 60,
                                          109, 101, 116, 97, 32, 99, 104, 97, 114, 115, 101, 116,
                                          61, 34, 85, 84, 70, 45, 56, 34, 47, 62, 60, 109, 101, 116,
                                          97, 32, 110, 97, 109, 101, 61, 34, 118, 105, 101, 119,
                                          112, 111, 114, 116, 34, 32, 99, 111, 110, 116, 101, 110,
                                          116, 61, 34, 119, 105, 100, 116, 104, 61, 100, 101, 118,
                                          105, 99, 101, 45, 119, 105, 100, 116, 104, 44, 32, 105,
                                          110, 105, 116, 105, 97, 108, 45, 115, 99, 97, 108, 101,
                                          61, 49, 46, 48, 34, 47, 62, 60, 109, 101, 116, 97, 32,
                                          104, 116, 116, 112, 45, 101, 113, 117, 105, 118, 61, 34,
                                          88, 45, 85, 65, 45, 67, 111, 109, 112, 97, 116, 105, 98,
                                          108, 101, 34, 32, 99, 111, 110, 116, 101, 110, 116, 61,
                                          34, 105, 101, 61, 101, 100, 103, 101, 34, 47, 62, 60, 116,
                                          105, 116, 108, 101, 62, 68, 111, 99, 117, 109, 101, 110,
                                          116, 60, 47, 116, 105, 116, 108, 101, 62, 60, 108, 105,
                                          110, 107, 32, 114, 101, 108, 61, 34, 115, 116, 121, 108,
                                          101, 115, 104, 101, 101, 116, 34, 32, 104, 114, 101, 102,
                                          61, 34, 114, 101, 115, 101, 116, 46, 99, 115, 115, 34, 47,
                                          62, 60, 108, 105, 110, 107, 32, 114, 101, 108, 61, 34,
                                          115, 116, 121, 108, 101, 115, 104, 101, 101, 116, 34, 32,
                                          104, 114, 101, 102, 61, 34, 108, 97, 121, 111, 117, 116,
                                          46, 99, 115, 115, 34, 47, 62, 60, 108, 105, 110, 107, 32,
                                          114, 101, 108, 61, 34, 115, 116, 121, 108, 101, 115, 104,
                                          101, 101, 116, 34, 32, 104, 114, 101, 102, 61, 34, 116,
                                          111, 97, 115, 116, 46, 99, 115, 115, 34, 47, 62, 60, 108,
                                          105, 110, 107, 32, 114, 101, 108, 61, 34, 115, 116, 121,
                                          108, 101, 115, 104, 101, 101, 116, 34, 32, 104, 114, 101,
                                          102, 61, 34, 104, 116, 116, 112, 115, 58, 47, 47, 99, 100,
                                          110, 106, 115, 46, 99, 108, 111, 117, 100, 102, 108, 97,
                                          114, 101, 46, 99, 111, 109, 47, 97, 106, 97, 120, 47, 108,
                                          105, 98, 115, 47, 115, 105, 109, 112, 108, 101, 109, 100,
                                          101, 47, 49, 46, 49, 49, 46, 50, 47, 115, 105, 109, 112,
                                          108, 101, 109, 100, 101, 46, 109, 105, 110, 46, 99, 115,
                                          115, 34, 47, 62, 60, 108, 105, 110, 107, 32, 114, 101,
                                          108, 61, 34, 115, 116, 121, 108, 101, 115, 104, 101, 101,
                                          116, 34, 32, 104, 114, 101, 102, 61, 34, 104, 116, 116,
                                          112, 115, 58, 47, 47, 99, 100, 110, 46, 106, 115, 100,
                                          101, 108, 105, 118, 114, 46, 110, 101, 116, 47, 110, 112,
                                          109, 47, 116, 111, 97, 115, 116, 105, 102, 121, 45, 106,
                                          115, 47, 115, 114, 99, 47, 116, 111, 97, 115, 116, 105,
                                          102, 121, 46, 109, 105, 110, 46, 99, 115, 115, 34, 47, 62,
                                          60, 115, 99, 114, 105, 112, 116, 32, 115, 114, 99, 61, 34,
                                          104, 116, 116, 112, 115, 58, 47, 47, 99, 100, 110, 106,
                                          115, 46, 99, 108, 111, 117, 100, 102, 108, 97, 114, 101,
                                          46, 99, 111, 109, 47, 97, 106, 97, 120, 47, 108, 105, 98,
                                          115, 47, 115, 105, 109, 112, 108, 101, 109, 100, 101, 47,
                                          49, 46, 49, 49, 46, 50, 47, 115, 105, 109, 112, 108, 101,
                                          109, 100, 101, 46, 109, 105, 110, 46, 106, 115, 34, 62,
                                          60, 47, 115, 99, 114, 105, 112, 116, 62, 60, 98, 111, 100,
                                          121, 62, 60, 100, 105, 118, 32, 99, 108, 97, 115, 115, 61,
                                          34, 119, 114, 97, 112, 112, 101, 114, 34, 62, 60, 115,
                                          101, 99, 116, 105, 111, 110, 32, 99, 108, 97, 115, 115,
                                          61, 34, 112, 97, 110, 101, 108, 32, 95, 110, 97, 118, 34,
                                          62, 60, 104, 101, 97, 100, 101, 114, 32, 99, 108, 97, 115,
                                          115, 61, 34, 112, 97, 110, 101, 108, 95, 95, 104, 101, 97,
                                          100, 101, 114, 34, 62, 60, 100, 105, 118, 32, 99, 108, 97,
                                          115, 115, 61, 34, 99, 111, 110, 116, 97, 105, 110, 101,
                                          114, 34, 62, 60, 102, 111, 114, 109, 32, 99, 108, 97, 115,
                                          115, 61, 34, 115, 101, 97, 114, 99, 104, 45, 98, 111, 120,
                                          34, 62, 60, 108, 97, 98, 101, 108, 32, 102, 111, 114, 61,
                                          34, 115, 101, 97, 114, 99, 104, 45, 98, 111, 120, 95, 95,
                                          105, 110, 112, 117, 116, 34, 32, 99, 108, 97, 115, 115,
                                          61, 34, 115, 101, 97, 114, 99, 104, 45, 98, 111, 120, 95,
                                          95, 108, 97, 98, 101, 108, 34, 62, 60, 47, 108, 97, 98,
                                          101, 108, 62, 32, 60, 105, 110, 112, 117, 116, 32, 116,
                                          121, 112, 101, 61, 34, 116, 101, 120, 116, 34, 32, 99,
                                          108, 97, 115, 115, 61, 34, 115, 101, 97, 114, 99, 104, 45,
                                          98, 111, 120, 95, 95, 105, 110, 112, 117, 116, 34, 47, 62,
                                          60, 100, 105, 118, 32, 99, 108, 97, 115, 115, 61, 34, 115,
                                          101, 97, 114, 99, 104, 45, 98, 111, 120, 95, 95, 99, 108,
                                          101, 97, 114, 34, 32, 116, 105, 116, 108, 101, 61, 34, 67,
                                          108, 101, 97, 114, 34, 62, 60, 47, 100, 105, 118, 62, 60,
                                          47, 102, 111, 114, 109, 62, 60, 47, 100, 105, 118, 62, 60,
                                          47, 104, 101, 97, 100, 101, 114, 62, 60, 110, 97, 118, 32,
                                          99, 108, 97, 115, 115, 61, 34, 112, 97, 110, 101, 108, 95,
                                          95, 99, 111, 110, 116, 101, 110, 116, 34, 62, 60, 100,
                                          105, 118, 32, 99, 108, 97, 115, 115, 61, 34, 99, 111, 110,
                                          116, 97, 105, 110, 101, 114, 32, 95, 110, 97, 118, 34, 62,
                                          60, 109, 101, 110, 117, 32, 99, 108, 97, 115, 115, 61, 34,
                                          110, 97, 118, 45, 116, 114, 101, 101, 34, 62, 60, 117,
                                          108, 32, 99, 108, 97, 115, 115, 61, 34, 110, 97, 118, 45,
                                          116, 114, 101, 101, 95, 95, 108, 105, 115, 116, 34, 62};

    static char t2[] =/* 1 1962  */{60, 47, 117, 108, 62, 60, 47, 109, 101, 110, 117, 62, 60, 47,
                                    100, 105, 118, 62, 60, 47, 110, 97, 118, 62, 60, 47, 115, 101,
                                    99, 116, 105, 111, 110, 62, 60, 109, 97, 105, 110, 32, 99, 108,
                                    97, 115, 115, 61, 34, 112, 97, 110, 101, 108, 32, 95, 109, 97,
                                    105, 110, 32, 95, 119, 105, 116, 104, 111, 117, 116, 45, 115,
                                    105, 100, 101, 98, 108, 111, 99, 107, 34, 62, 60, 104, 101, 97,
                                    100, 101, 114, 32, 99, 108, 97, 115, 115, 61, 34, 112, 97, 110,
                                    101, 108, 95, 95, 104, 101, 97, 100, 101, 114, 32, 104, 101, 97,
                                    100, 101, 114, 32, 95, 102, 105, 120, 101, 100, 32, 95, 99, 108,
                                    97, 109, 112, 101, 100, 34, 62, 60, 100, 105, 118, 32, 99, 108,
                                    97, 115, 115, 61, 34, 99, 111, 110, 116, 97, 105, 110, 101, 114,
                                    32, 104, 101, 97, 100, 101, 114, 95, 95, 99, 111, 110, 116, 97,
                                    105, 110, 101, 114, 34, 62, 60, 100, 105, 118, 32, 99, 108, 97,
                                    115, 115, 61, 34, 104, 101, 97, 100, 101, 114, 95, 95, 116, 105,
                                    116, 108, 101, 34, 62, 60, 104, 51, 32, 105, 100, 61, 34, 116,
                                    105, 116, 108, 101, 34, 62, 60, 47, 104, 51, 62, 60, 100, 105,
                                    118, 32, 99, 108, 97, 115, 115, 61, 34, 112, 97, 110, 101, 108,
                                    45, 116, 114, 105, 103, 103, 101, 114, 34, 62, 60, 47, 100, 105,
                                    118, 62, 60, 47, 100, 105, 118, 62, 60, 100, 105, 118, 32, 99,
                                    108, 97, 115, 115, 61, 34, 104, 101, 97, 100, 101, 114, 95, 95,
                                    99, 111, 110, 116, 114, 111, 108, 115, 34, 62, 60, 47, 100, 105,
                                    118, 62, 60, 47, 100, 105, 118, 62, 60, 47, 104, 101, 97, 100,
                                    101, 114, 62, 60, 100, 105, 118, 32, 99, 108, 97, 115, 115, 61,
                                    34, 112, 97, 110, 101, 108, 95, 95, 104, 101, 97, 100, 101, 114,
                                    32, 104, 101, 97, 100, 101, 114, 32, 95, 101, 109, 117, 108, 97,
                                    116, 111, 114, 34, 32, 115, 116, 121, 108, 101, 61, 34, 104,
                                    101, 105, 103, 104, 116, 58, 50, 50, 112, 120, 34, 62, 60, 47,
                                    100, 105, 118, 62, 60, 115, 101, 99, 116, 105, 111, 110, 32, 99,
                                    108, 97, 115, 115, 61, 34, 112, 97, 110, 101, 108, 95, 95, 99,
                                    111, 110, 116, 101, 110, 116, 34, 62, 60, 116, 101, 120, 116,
                                    97, 114, 101, 97, 32, 105, 100, 61, 34, 101, 100, 105, 116, 45,
                                    116, 101, 120, 116, 34, 62, 60, 47, 116, 101, 120, 116, 97, 114,
                                    101, 97, 62, 60, 47, 115, 101, 99, 116, 105, 111, 110, 62, 60,
                                    47, 109, 97, 105, 110, 62, 60, 47, 100, 105, 118, 62, 60, 100,
                                    105, 118, 32, 99, 108, 97, 115, 115, 61, 34, 116, 111, 97, 115,
                                    116, 95, 95, 108, 97, 121, 111, 117, 116, 32, 116, 111, 97, 115,
                                    116, 45, 45, 104, 105, 100, 100, 101, 110, 34, 62, 60, 100, 105,
                                    118, 32, 99, 108, 97, 115, 115, 61, 34, 116, 111, 97, 115, 116,
                                    95, 95, 99, 111, 110, 116, 97, 105, 110, 101, 114, 34, 62, 60,
                                    100, 105, 118, 32, 99, 108, 97, 115, 115, 61, 34, 116, 111, 97,
                                    115, 116, 95, 95, 99, 101, 108, 108, 34, 62, 60, 100, 105, 118,
                                    32, 99, 108, 97, 115, 115, 61, 34, 116, 111, 97, 115, 116, 32,
                                    116, 111, 97, 115, 116, 45, 45, 121, 101, 108, 108, 111, 119,
                                    32, 97, 100, 100, 45, 109, 97, 114, 103, 105, 110, 34, 62, 60,
                                    100, 105, 118, 32, 99, 108, 97, 115, 115, 61, 34, 116, 111, 97,
                                    115, 116, 95, 95, 105, 99, 111, 110, 34, 62, 60, 115, 118, 103,
                                    32, 118, 101, 114, 115, 105, 111, 110, 61, 34, 49, 46, 49, 34,
                                    32, 99, 108, 97, 115, 115, 61, 34, 116, 111, 97, 115, 116, 95,
                                    95, 115, 118, 103, 34, 32, 120, 109, 108, 110, 115, 61, 34, 104,
                                    116, 116, 112, 58, 47, 47, 119, 119, 119, 46, 119, 51, 46, 111,
                                    114, 103, 47, 50, 48, 48, 48, 47, 115, 118, 103, 34, 32, 120,
                                    109, 108, 110, 115, 58, 120, 108, 105, 110, 107, 61, 34, 104,
                                    116, 116, 112, 58, 47, 47, 119, 119, 119, 46, 119, 51, 46, 111,
                                    114, 103, 47, 49, 57, 57, 57, 47, 120, 108, 105, 110, 107, 34,
                                    32, 120, 61, 34, 48, 112, 120, 34, 32, 121, 61, 34, 48, 112,
                                    120, 34, 32, 118, 105, 101, 119, 66, 111, 120, 61, 34, 48, 32,
                                    48, 32, 51, 48, 49, 46, 54, 57, 49, 32, 51, 48, 49, 46, 54, 57,
                                    49, 34, 32, 115, 116, 121, 108, 101, 61, 34, 101, 110, 97, 98,
                                    108, 101, 45, 98, 97, 99, 107, 103, 114, 111, 117, 110, 100, 58,
                                    110, 101, 119, 32, 48, 32, 48, 32, 51, 48, 49, 46, 54, 57, 49,
                                    32, 51, 48, 49, 46, 54, 57, 49, 34, 32, 120, 109, 108, 58, 115,
                                    112, 97, 99, 101, 61, 34, 112, 114, 101, 115, 101, 114, 118,
                                    101, 34, 62, 60, 103, 62, 60, 112, 111, 108, 121, 103, 111, 110,
                                    32, 112, 111, 105, 110, 116, 115, 61, 34, 49, 49, 57, 46, 49,
                                    53, 49, 44, 48, 32, 49, 50, 57, 46, 54, 44, 50, 49, 56, 46, 52,
                                    48, 54, 32, 49, 55, 50, 46, 48, 54, 44, 50, 49, 56, 46, 52, 48,
                                    54, 32, 49, 56, 50, 46, 53, 52, 44, 48, 32, 32, 34, 62, 60, 47,
                                    112, 111, 108, 121, 103, 111, 110, 62, 60, 114, 101, 99, 116,
                                    32, 120, 61, 34, 49, 51, 48, 46, 53, 54, 51, 34, 32, 121, 61,
                                    34, 50, 54, 49, 46, 49, 54, 56, 34, 32, 119, 105, 100, 116, 104,
                                    61, 34, 52, 48, 46, 53, 50, 53, 34, 32, 104, 101, 105, 103, 104,
                                    116, 61, 34, 52, 48, 46, 53, 50, 51, 34, 62, 60, 47, 114, 101,
                                    99, 116, 62, 60, 47, 103, 62, 60, 47, 115, 118, 103, 62, 60, 47,
                                    100, 105, 118, 62, 60, 100, 105, 118, 32, 99, 108, 97, 115, 115,
                                    61, 34, 116, 111, 97, 115, 116, 95, 95, 99, 111, 110, 116, 101,
                                    110, 116, 34, 62, 60, 112, 32, 99, 108, 97, 115, 115, 61, 34,
                                    116, 111, 97, 115, 116, 95, 95, 116, 121, 112, 101, 34, 62, 83,
                                    117, 99, 99, 101, 115, 115, 60, 112, 32, 99, 108, 97, 115, 115,
                                    61, 34, 116, 111, 97, 115, 116, 95, 95, 109, 101, 115, 115, 97,
                                    103, 101, 34, 62, 65, 110, 121, 111, 110, 101, 32, 119, 105,
                                    116, 104, 32, 97, 99, 99, 101, 115, 115, 32, 99, 97, 110, 32,
                                    118, 105, 101, 119, 32, 121, 111, 117, 114, 32, 105, 110, 118,
                                    105, 116, 101, 100, 32, 118, 105, 115, 105, 116, 111, 114, 115,
                                    46, 60, 47, 100, 105, 118, 62, 60, 100, 105, 118, 32, 99, 108,
                                    97, 115, 115, 61, 34, 116, 111, 97, 115, 116, 95, 95, 99, 108,
                                    111, 115, 101, 34, 62, 60, 115, 118, 103, 32, 118, 101, 114,
                                    115, 105, 111, 110, 61, 34, 49, 46, 49, 34, 32, 120, 109, 108,
                                    110, 115, 61, 34, 104, 116, 116, 112, 58, 47, 47, 119, 119, 119,
                                    46, 119, 51, 46, 111, 114, 103, 47, 50, 48, 48, 48, 47, 115,
                                    118, 103, 34, 32, 118, 105, 101, 119, 66, 111, 120, 61, 34, 48,
                                    32, 48, 32, 49, 53, 46, 54, 52, 50, 32, 49, 53, 46, 54, 52, 50,
                                    34, 32, 120, 109, 108, 110, 115, 58, 120, 108, 105, 110, 107,
                                    61, 34, 104, 116, 116, 112, 58, 47, 47, 119, 119, 119, 46, 119,
                                    51, 46, 111, 114, 103, 47, 49, 57, 57, 57, 47, 120, 108, 105,
                                    110, 107, 34, 32, 101, 110, 97, 98, 108, 101, 45, 98, 97, 99,
                                    107, 103, 114, 111, 117, 110, 100, 61, 34, 110, 101, 119, 32,
                                    48, 32, 48, 32, 49, 53, 46, 54, 52, 50, 32, 49, 53, 46, 54, 52,
                                    50, 34, 62, 60, 112, 97, 116, 104, 32, 102, 105, 108, 108, 45,
                                    114, 117, 108, 101, 61, 34, 101, 118, 101, 110, 111, 100, 100,
                                    34, 32, 100, 61, 34, 77, 56, 46, 56, 56, 50, 44, 55, 46, 56, 50,
                                    49, 108, 54, 46, 53, 52, 49, 45, 54, 46, 53, 52, 49, 99, 48, 46,
                                    50, 57, 51, 45, 48, 46, 50, 57, 51, 44, 48, 46, 50, 57, 51, 45,
                                    48, 46, 55, 54, 56, 44, 48, 45, 49, 46, 48, 54, 49, 32, 32, 99,
                                    45, 48, 46, 50, 57, 51, 45, 48, 46, 50, 57, 51, 45, 48, 46, 55,
                                    54, 56, 45, 48, 46, 50, 57, 51, 45, 49, 46, 48, 54, 49, 44, 48,
                                    76, 55, 46, 56, 50, 49, 44, 54, 46, 55, 54, 76, 49, 46, 50, 56,
                                    44, 48, 46, 50, 50, 99, 45, 48, 46, 50, 57, 51, 45, 48, 46, 50,
                                    57, 51, 45, 48, 46, 55, 54, 56, 45, 48, 46, 50, 57, 51, 45, 49,
                                    46, 48, 54, 49, 44, 48, 99, 45, 48, 46, 50, 57, 51, 44, 48, 46,
                                    50, 57, 51, 45, 48, 46, 50, 57, 51, 44, 48, 46, 55, 54, 56, 44,
                                    48, 44, 49, 46, 48, 54, 49, 32, 32, 108, 54, 46, 53, 52, 49, 44,
                                    54, 46, 53, 52, 49, 76, 48, 46, 50, 50, 44, 49, 52, 46, 51, 54,
                                    50, 99, 45, 48, 46, 50, 57, 51, 44, 48, 46, 50, 57, 51, 45, 48,
                                    46, 50, 57, 51, 44, 48, 46, 55, 54, 56, 44, 48, 44, 49, 46, 48,
                                    54, 49, 99, 48, 46, 49, 52, 55, 44, 48, 46, 49, 52, 54, 44, 48,
                                    46, 51, 51, 56, 44, 48, 46, 50, 50, 44, 48, 46, 53, 51, 44, 48,
                                    46, 50, 50, 115, 48, 46, 51, 56, 52, 45, 48, 46, 48, 55, 51, 44,
                                    48, 46, 53, 51, 45, 48, 46, 50, 50, 108, 54, 46, 53, 52, 49, 45,
                                    54, 46, 53, 52, 49, 32, 32, 108, 54, 46, 53, 52, 49, 44, 54, 46,
                                    53, 52, 49, 99, 48, 46, 49, 52, 55, 44, 48, 46, 49, 52, 54, 44,
                                    48, 46, 51, 51, 56, 44, 48, 46, 50, 50, 44, 48, 46, 53, 51, 44,
                                    48, 46, 50, 50, 99, 48, 46, 49, 57, 50, 44, 48, 44, 48, 46, 51,
                                    56, 52, 45, 48, 46, 48, 55, 51, 44, 48, 46, 53, 51, 45, 48, 46,
                                    50, 50, 99, 48, 46, 50, 57, 51, 45, 48, 46, 50, 57, 51, 44, 48,
                                    46, 50, 57, 51, 45, 48, 46, 55, 54, 56, 44, 48, 45, 49, 46, 48,
                                    54, 49, 76, 56, 46, 56, 56, 50, 44, 55, 46, 56, 50, 49, 122, 34,
                                    62, 60, 47, 112, 97, 116, 104, 62, 60, 47, 115, 118, 103, 62,
                                    60, 47, 100, 105, 118, 62, 60, 47, 100, 105, 118, 62, 60, 47,
                                    100, 105, 118, 62, 60, 47, 100, 105, 118, 62, 60, 47, 100, 105,
                                    118, 62, 60, 115, 99, 114, 105, 112, 116, 32, 115, 114, 99, 61,
                                    34, 97, 112, 112, 46, 106, 115, 34, 62, 60, 47, 115, 99, 114,
                                    105, 112, 116, 62, 60, 115, 99, 114, 105, 112, 116, 32, 115,
                                    114, 99, 61, 34, 116, 111, 97, 115, 116, 46, 106, 115, 34, 62,
                                    60, 47, 115, 99, 114, 105, 112, 116, 62, 60, 115, 99, 114, 105,
                                    112, 116, 32, 115, 114, 99, 61, 34, 101, 100, 105, 116, 111,
                                    114, 46, 106, 115, 34, 62, 60, 47, 115, 99, 114, 105, 112, 116,
                                    62};

    struct http_message *hm = (struct http_message *) ev_data;
    if (ev == MG_EV_HTTP_REQUEST) {
        if (is_equal(&hm->uri, &api_index)) {
            LOGE("%s", "/");
            mg_send_head(nc, 200, 1050 + 1962, "Content-Type: text/html");
            mg_send(nc, t1, 1050);
            mg_send(nc, t2, 1962);
        } else {
            mg_serve_http(nc, hm, s_http_server_opts); /* Serve static content */
        }
    }
//    else {
//        mg_printf(nc, "%s",
//                  "HTTP/1.0 501 Not Implemented\r\n"
//                  "Content-Length: 0\r\n\r\n");
//    }
//    char buf[100];
//    memcpy(buf, hm->uri.p, hm->uri.len);
//    LOGE("%d %s", ev, buf);
}

void StartServer(const char *address) {
    struct mg_mgr mgr;
    struct mg_connection *nc;
    int i;

    mg_mgr_init(&mgr, NULL);
    nc = mg_bind(&mgr, address, ev_handler);
    mg_set_protocol_http_websocket(nc);
    for (;;) {
        mg_mgr_poll(&mgr, 1000);
    }
    mg_mgr_free(&mgr);

}

JNIEXPORT void JNICALL
Java_euphoria_psycho_notepad_NativeMethods_createDatabase(JNIEnv *env, jclass type,
                                                          jstring fileName_) {
    char device[512], path[512];
    GetIP(device);
    strcat(device, ":8090");

    GetPath(env, path);
    strcat(path, "/server");
    LOGE("%s %s\n", device, path);
    s_http_server_opts.document_root = path;
    StartServer(device);

    const char *fileName = (*env)->GetStringUTFChars(env, fileName_, 0);

    //CreateDatabase(fileName);

    (*env)->ReleaseStringUTFChars(env, fileName_, fileName);
}